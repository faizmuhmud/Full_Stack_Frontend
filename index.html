<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>After School Classes</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header>
            <h1>{{ appName }}</h1>
            <nav>
                <button @click="showLessons" :class="{ active: currentPage === 'lessons' }">
                    Lessons
                </button>
                <button @click="showCart" :class="{ active: currentPage === 'cart' }" :disabled="cartCount === 0">
                    üõí Cart <span v-if="cartCount > 0" class="cart-badge">{{ cartCount }}</span>
                </button>
            </nav>
        </header>

        <!-- Main Container -->
        <div class="container">
            <!-- Lessons Page -->
            <div v-if="currentPage === 'lessons'">
                <h2>Available Classes</h2>

                <!-- Search Bar -->
                <div class="search-container">
                    <input 
                        type="text" 
                        v-model="searchQuery" 
                        placeholder="üîç Search by subject or location..."
                        class="search-input"
                    >
                    <button v-if="searchQuery" @click="searchQuery = ''" class="clear-btn">√ó</button>
                </div>

                <!-- Sort Controls -->
                <div class="sort-container">
                    <label>Sort By:</label>
                    <select v-model="sortBy" class="sort-select">
                        <option value="">None</option>
                        <option value="subject">Subject</option>
                        <option value="location">Location</option>
                        <option value="price">Price</option>
                        <option value="availability">Availability</option>
                    </select>

                    <label>Order:</label>
                    <select v-model="sortOrder" class="sort-select" :disabled="!sortBy">
                        <option value="asc">Ascending</option>
                        <option value="desc">Descending</option>
                    </select>
                </div>

                <!-- Loading State -->
                <div v-if="loading" style="text-align: center; color: white; font-size: 1.5rem; padding: 3rem;">
                    Loading lessons...
                </div>

                <!-- Error State -->
                <div v-if="error" style="text-align: center; color: white; font-size: 1.2rem; padding: 2rem; background: rgba(248, 113, 113, 0.2); border-radius: 15px;">
                    Error: {{ error }}
                </div>

                <!-- Lessons Grid -->
                <div v-if="!loading && !error" class="lessons-grid">
                    <div v-for="lesson in sortedLessons" :key="lesson._id" class="lesson-card">
                        <div class="lesson-image">
                            <img 
                                :src="getImageUrl(lesson)" 
                                :alt="lesson.subject"
                                @error="handleImageError"
                            >
                        </div>
                        <div class="lesson-details">
                            <h3>{{ lesson.subject }}</h3>
                            <p>üìç <strong>Location:</strong> {{ lesson.location }}</p>
                            <p class="price">¬£{{ lesson.price.toFixed(2) }}</p>
                            <p>üë• <strong>Available Spaces:</strong> {{ lesson.spaces }}</p>
                            <button 
                                @click="addToCart(lesson)" 
                                :disabled="lesson.spaces === 0"
                                class="add-btn"
                            >
                                {{ lesson.spaces === 0 ? 'Sold Out' : 'Add to Cart' }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- No Results -->
                <div v-if="!loading && !error && sortedLessons.length === 0" style="text-align: center; color: white; font-size: 1.2rem; padding: 3rem;">
                    No lessons found matching your search.
                </div>
            </div>

            <!-- Cart Page -->
            <div v-if="currentPage === 'cart'" class="cart-section">
                <h2>Shopping Cart</h2>

                <div v-if="cart.length === 0" style="text-align: center; padding: 3rem; color: var(--text-light);">
                    <p style="font-size: 1.5rem;">Your cart is empty</p>
                    <button @click="showLessons" class="add-btn" style="margin-top: 1.5rem;">Browse Lessons</button>
                </div>

                <div v-else>
                    <div v-for="item in cart" :key="item._id || item.id" class="cart-item">
                        <div style="flex: 1;">
                            <h3>{{ item.subject }}</h3>
                            <p>üìç {{ item.location }}</p>
                            <p>üí∑ ¬£{{ item.price.toFixed(2) }} each</p>
                            <p><strong>Subtotal:</strong> ¬£{{ (item.price * item.qty).toFixed(2) }}</p>
                        </div>
                        <div class="qty-controls">
                            <button @click="decreaseQty(item)" class="qty-btn" :disabled="item.qty <= 1">‚àí</button>
                            <span style="font-weight: 700; font-size: 1.1rem; min-width: 30px; text-align: center;">{{ item.qty }}</span>
                            <button @click="increaseQty(item)" class="qty-btn">+</button>
                        </div>
                        <button @click="removeLesson(item)" class="remove-btn">Remove</button>
                    </div>

                    <div class="cart-summary">
                        <h3>Total: ¬£{{ cartTotal.toFixed(2) }}</h3>
                        <button @click="showCheckout" class="checkout-btn">Proceed to Checkout</button>
                    </div>
                </div>
            </div>

            <!-- Checkout Page -->
            <div v-if="currentPage === 'checkout'" class="checkout-form">
                <h2>Checkout Information</h2>

                <form @submit.prevent="submitOrder">
                    <label for="firstName">First Name *</label>
                    <input 
                        type="text" 
                        id="firstName"
                        v-model="customer.firstName"
                        @blur="validateField('firstName')"
                        :class="{ error: errors.firstName }"
                    >
                    <p v-if="errors.firstName" style="color: var(--danger-color); font-size: 0.9rem; margin-top: 0.25rem;">{{ errors.firstName }}</p>

                    <label for="lastName">Last Name *</label>
                    <input 
                        type="text" 
                        id="lastName"
                        v-model="customer.lastName"
                        @blur="validateField('lastName')"
                        :class="{ error: errors.lastName }"
                    >
                    <p v-if="errors.lastName" style="color: var(--danger-color); font-size: 0.9rem; margin-top: 0.25rem;">{{ errors.lastName }}</p>

                    <label for="address">Address *</label>
                    <input 
                        type="text" 
                        id="address"
                        v-model="customer.address"
                        @blur="validateField('address')"
                        :class="{ error: errors.address }"
                    >
                    <p v-if="errors.address" style="color: var(--danger-color); font-size: 0.9rem; margin-top: 0.25rem;">{{ errors.address }}</p>

                    <label for="city">City *</label>
                    <input 
                        type="text" 
                        id="city"
                        v-model="customer.city"
                        @blur="validateField('city')"
                        :class="{ error: errors.city }"
                    >
                    <p v-if="errors.city" style="color: var(--danger-color); font-size: 0.9rem; margin-top: 0.25rem;">{{ errors.city }}</p>

                    <label for="postal">Postal Code *</label>
                    <input 
                        type="text" 
                        id="postal"
                        v-model="customer.postal"
                        @blur="validateField('postal')"
                        :class="{ error: errors.postal }"
                    >
                    <p v-if="errors.postal" style="color: var(--danger-color); font-size: 0.9rem; margin-top: 0.25rem;">{{ errors.postal }}</p>

                    <div class="gift-toggle">
                        <input 
                            type="checkbox" 
                            id="isGift"
                            v-model="customer.isGift"
                        >
                        <label for="isGift">This order is a gift</label>
                    </div>

                    <!-- Order Summary -->
                    <div class="order-summary">
                        <h3>Order Summary</h3>
                        <p v-for="item in cart" :key="item._id || item.id">
                            <span>{{ item.subject }} (x{{ item.qty }})</span>
                            <strong>¬£{{ (item.price * item.qty).toFixed(2) }}</strong>
                        </p>
                        <p>
                            <span>Total Amount:</span>
                            <strong>¬£{{ cartTotal.toFixed(2) }}</strong>
                        </p>
                    </div>

                    <button type="submit" class="submit-btn">Place Order</button>
                </form>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>